version: 2
jobs:
  build:
    machine: true
    environment:
      - PHOENIX_ECR: 564677439943.dkr.ecr.ap-northeast-1.amazonaws.com/h3poteto/pleroma/phoenix
      - NGINX_ECR: 564677439943.dkr.ecr.ap-northeast-1.amazonaws.com/h3poteto/pleroma/nginx
      - CLUSTER_NAME: base-default-prd
      - SERVICE_NAME: pleroma-web-prd
      - RUN_TASK_DEFINITION: pleroma-web-prd-task:6
      - AWS_DEFAULT_REGION: ap-northeast-1
    steps:
      - checkout
      - run:
          name: phoenix docker build
          command: |
            docker build -t $PHOENIX_ECR:$CIRCLE_SHA1 -f dockerfiles/phoenix/Dockerfile .
      - run:
          name: phoenix docker push
          command: |
            $(aws ecr get-login --no-include-email --region ap-northeast-1)
            docker push $PHOENIX_ECR:$CIRCLE_SHA1
      - run:
          name: nginx docker build
          command: |
            cd dockerfiles/nginx
            docker build -t $NGINX_ECR:latest .
      - run:
          name: nginx docker push
          command: |
            $(aws ecr get-login --no-include-email --region ap-northeast-1)
            docker push $NGINX_ECR:latest
      - run: &prepare_goploy
          name: Preparing ecs-goploy
          command: |
            wget https://github.com/h3poteto/ecs-goploy/releases/download/v0.4.0/ecs-goploy_v0.4.0_linux_amd64.zip
            unzip ecs-goploy_v0.4.0_linux_amd64.zip
            ./ecs-goploy version
      - run:
          name: migrate
          command: |
            set -ex
            NEW_TASK_DEFINITION=`./ecs-goploy update task-definition --base-task-definition ${RUN_TASK_DEFINITION} --image ${PHOENIX_ECR}:$CIRCLE_SHA1`
            ./ecs-goploy run task --verbose --cluster ${CLUSTER_NAME} --container-name phoenix --timeout 600 --task-definition $NEW_TASK_DEFINITION --command "mix ecto.migrate"
      - run:
          name: deploy
          command: |
            ./ecs-goploy update service --verbose --cluster ${CLUSTER_NAME} --service-name ${SERVICE_NAME} --image ${PHOENIX_ECR}:$CIRCLE_SHA1 --timeout 600 --enable-rollback --skip-check-deployments
